// Prisma schema for AIP Registry
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id          String   @id
  name        String
  version     String
  description String?
  
  // JSON fields for flexible schema
  endpoints   Json?
  pricing     Json?
  metadata    Json?
  proofOfWork Json?    @map("proof_of_work")
  
  // Relations
  capabilities     Capability[]
  metrics          Metrics?
  reviews          Review[]
  reputationScore  ReputationScore?
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([name])
  @@map("agents")
}

model Capability {
  id         Int    @id @default(autoincrement())
  agentId    String @map("agent_id")
  agent      Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  skill      String
  confidence Float
  parameters Json?
  
  @@index([skill])
  @@index([agentId, skill])
  @@map("capabilities")
}

model Metrics {
  id                Int      @id @default(autoincrement())
  agentId           String   @unique @map("agent_id")
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  tasksCompleted    Int?     @map("tasks_completed")
  avgResponseTimeMs Int?     @map("avg_response_time_ms")
  successRate       Float?   @map("success_rate")
  uptime30d         Float?   @map("uptime_30d")
  
  // Custom metrics as JSON
  customMetrics     Json?    @map("custom_metrics")
  
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("metrics")
}

model ApiKey {
  id          String    @id @default(uuid())
  key         String    @unique
  name        String
  description String?
  
  // Permissions
  permissions Json      @default("{\"read\": true, \"write\": false, \"delete\": false}")
  rateLimit   Int?      @default(100) @map("rate_limit")
  
  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")
  
  @@index([isActive])
  @@map("api_keys")
}

model Webhook {
  id               String    @id @default(uuid())
  url              String
  events           String[]  @default(["agent.registered", "agent.updated", "agent.deleted"])
  secret           String?
  isActive         Boolean   @default(true) @map("is_active")
  lastTriggeredAt  DateTime? @map("last_triggered_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  
  @@index([isActive])
  @@map("webhooks")
}

enum ReviewRating {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

model Review {
  id         String       @id @default(uuid())
  agentId    String       @map("agent_id")
  agent      Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  reviewerId String?      @map("reviewer_id")
  rating     ReviewRating
  comment    String?
  metadata   Json?
  createdAt  DateTime     @default(now()) @map("created_at")
  
  @@index([agentId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model ReputationScore {
  id                String   @id @default(uuid())
  agentId           String   @unique @map("agent_id")
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Composite scores (0.0 - 1.0)
  overallScore      Float    @default(0.5) @map("overall_score")
  performanceScore  Float    @default(0.5) @map("performance_score")
  reliabilityScore  Float    @default(0.5) @map("reliability_score")
  communityScore    Float    @default(0.5) @map("community_score")
  
  // Review statistics
  totalReviews      Int      @default(0) @map("total_reviews")
  positiveReviews   Int      @default(0) @map("positive_reviews")
  neutralReviews    Int      @default(0) @map("neutral_reviews")
  negativeReviews   Int      @default(0) @map("negative_reviews")
  
  lastCalculatedAt  DateTime @default(now()) @map("last_calculated_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@index([overallScore])
  @@map("reputation_scores")
}

model FederatedRegistry {
  id                   String            @id @default(uuid())
  name                 String
  url                  String            @unique
  apiKey               String?           @map("api_key")
  isActive             Boolean           @default(true) @map("is_active")
  isTrusted            Boolean           @default(false) @map("is_trusted")
  syncEnabled          Boolean           @default(true) @map("sync_enabled")
  lastSyncAt           DateTime?         @map("last_sync_at")
  syncIntervalMinutes  Int               @default(60) @map("sync_interval_minutes")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  
  federatedAgents      FederatedAgent[]
  
  @@index([isActive])
  @@map("federated_registries")
}

model FederatedAgent {
  id                String             @id @default(uuid())
  agentId           String             @map("agent_id")
  sourceRegistryId  String             @map("source_registry_id")
  sourceRegistry    FederatedRegistry  @relation(fields: [sourceRegistryId], references: [id], onDelete: Cascade)
  sourceUrl         String             @map("source_url")
  agentData         Json               @map("agent_data")
  isVerified        Boolean            @default(false) @map("is_verified")
  lastSyncedAt      DateTime           @default(now()) @map("last_synced_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  
  @@unique([agentId, sourceRegistryId])
  @@index([agentId])
  @@index([sourceRegistryId])
  @@map("federated_agents")
}
