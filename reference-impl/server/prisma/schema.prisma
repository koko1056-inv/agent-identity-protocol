// Prisma schema for AIP Registry
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id          String   @id
  name        String
  version     String
  description String?
  
  // JSON fields for flexible schema
  endpoints   Json?
  pricing     Json?
  metadata    Json?
  proofOfWork Json?    @map("proof_of_work")
  
  // Relations
  capabilities Capability[]
  metrics      Metrics?
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([name])
  @@map("agents")
}

model Capability {
  id         Int    @id @default(autoincrement())
  agentId    String @map("agent_id")
  agent      Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  skill      String
  confidence Float
  parameters Json?
  
  @@index([skill])
  @@index([agentId, skill])
  @@map("capabilities")
}

model Metrics {
  id                Int      @id @default(autoincrement())
  agentId           String   @unique @map("agent_id")
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  tasksCompleted    Int?     @map("tasks_completed")
  avgResponseTimeMs Int?     @map("avg_response_time_ms")
  successRate       Float?   @map("success_rate")
  uptime30d         Float?   @map("uptime_30d")
  
  // Custom metrics as JSON
  customMetrics     Json?    @map("custom_metrics")
  
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("metrics")
}

model ApiKey {
  id          String    @id @default(uuid())
  key         String    @unique
  name        String
  description String?
  
  // Permissions
  permissions Json      @default("{\"read\": true, \"write\": false, \"delete\": false}")
  rateLimit   Int?      @default(100) @map("rate_limit")
  
  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")
  
  @@index([isActive])
  @@map("api_keys")
}

model Webhook {
  id               String    @id @default(uuid())
  url              String
  events           String[]  @default(["agent.registered", "agent.updated", "agent.deleted"])
  secret           String?
  isActive         Boolean   @default(true) @map("is_active")
  lastTriggeredAt  DateTime? @map("last_triggered_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  
  @@index([isActive])
  @@map("webhooks")
}
